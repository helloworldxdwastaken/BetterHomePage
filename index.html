<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BetterHome</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tokyo Homepage">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1e1e1e;
            --fg-color: #ffffff;
        }

        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-color);
            color: var(--fg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
            position: relative;
            z-index: 0;
        }

        /* semiâ€“transparent overlay to darken wallpaper */
        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.50);
            /* adjust opacity as desired */
            pointer-events: none;
            /* let clicks through */
            z-index: 0;
            /* below page content */
        }

        /* ensure overlay is below content */
        body>* {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2.8rem;
            font-weight: 600;
            /* semiâ€‘bold */
        }

        /* Center the greeting text */
        #greeting {
            width: 100%;
            text-align: center;
        }

        .quote {
            font-style: italic;
            opacity: 0.7;
            margin-bottom: 10px;
            font-weight: 600;
            /* semiâ€‘bold */
        }

        .clock {
            font-size: 9rem;
            margin: 10px 0;
            font-weight: bold;
        }



        .search-bar {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            margin-top: 20vh;
            /* push it down from the clock */
        }

        .search-bar button {
            background: #ffffff;
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            color: #000;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .engine-select {
            position: absolute;
            right: 0;
            flex-direction: column;
            align-items: center;
            background-color: #333;
            padding: 5px;
            border-radius: 6px;
            display: none;
            z-index: 10;
        }

        .engine-select.show {
            display: flex;
        }

        .engine-wrapper {
            position: relative;
            margin-left: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .engine-icon {
            height: 35px;
            width: 35px;
            margin: 5px 0;
            opacity: 0.6;
            cursor: pointer;
            border-radius: 50%;
            transition: opacity 0.3s;
        }

        .engine-icon.active,
        .engine-icon:hover {
            opacity: 1;
            cursor: pointer;
        }

        input {
            padding: 10px;
            border-radius: 20px;
            border: none;
            font-size: 1rem;
            width: 400px;
            /* fixed length */
        }

        .bookmarks {
            display: grid;
            grid-template-columns: repeat(6, 70px);
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .bookmark {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: #ffffff;
            text-decoration: none;
            width: 70px;
            font-size: 0.8rem;
        }

        .bookmark-add {
            width: 70px;
            height: 70px;
            border: 2px dashed #888;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 2rem;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }

        .bookmark-add:hover {
            border-color: #fff;
            color: #fff;
        }

        .bookmark img {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
        }

        .bookmark-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px;
            box-sizing: border-box;
        }

        .bookmark-name {
            display: block;
            margin-top: 2px;
            word-break: break-word;
            font-weight: 500;
            /* semiâ€‘bold */
        }

        /* Weather container styling */
        #weather.bookmark {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        /* Hide weather addon on viewports narrower than 1000px */
        @media (max-width: 1000px) {
            #weather.bookmark {
                display: none;
            }
        }

        /* Enhanced mobile-friendly styles */
        @media (max-width: 600px) {

            /* Body adjustments */
            body {
                padding: 10px 5px;
                /* height: auto; */
                min-height: 100vh;
                justify-content: flex-start;
            }

            /* Greeting */
            #greeting {
                font-size: 1.8rem;
                margin-top: 20px;
            }

            /* Quote */
            .quote {
                font-size: 0.9rem;
                margin: 5px 0;
            }

            /* Clock */
            .clock {
                font-size: 4rem;
                margin: 5px 0;
            }

            /* Search bar */
            .search-bar {
                margin: 15px 0;
                width: 100%;
                flex-direction: column;
                align-items: center;
            }

            input {
                width: 100%;
                max-width: none;
            }

            .engine-wrapper {
                margin: 10px 0;
                justify-content: center;
            }

            /* Bookmarks grid */
            .bookmarks {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
                margin-top: 15px;
                max-height: none;
                width: 100%;
                padding: 0 10px;
            }

            .bookmark,
            .bookmark-add {
                width: 60px;
            }

            .bookmark-icon {
                width: 32px;
                height: 32px;
            }

            .bookmark-name {
                font-size: 0.7rem;
            }

            /* Hide tools pane completely */
            .tools {
                display: none;
            }
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #fafafa;
                --fg-color: #111111;
            }

            body::before {
                background: rgba(255, 255, 255, 0.35);
            }
        }

        /* Tools pane positioning and weather widget style */
        .tools {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            /* background: rgba(0, 0, 0, 0.5); */
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Username styling */
        #username {
            cursor: pointer;
        }

        #username:hover {
            text-decoration: underline dashed;
        }

        #weather {
            font-size: 0.9rem;
        }

        /* Weather card styling matching bookmarks */
        .weather-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .weather-temp,
        .weather-wind {
            font-size: 0.8rem;
            text-align: center;
        }

        /* Enhanced weather widget layout */
        .weather-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            margin-bottom: 8px;
            text-align: center;
            gap: 4px;
        }

        .weather-location {
            font-weight: bold;
        }

        .weather-update {
            opacity: 0.7;
        }

        .weather-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }

        .weather-temp-large {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .weather-forecast {
            display: flex;
            justify-content: center;
            gap: 12px;
            /* prevent wrapping so items stay side by side */
            flex-wrap: nowrap;
            padding: 0 4px;
        }

        .forecast-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
        }

        .forecast-name {
            margin-bottom: 2px;
        }

        .forecast-icon {
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .forecast-range {}

        @media (max-width: 600px) {
            .tools {
                position: static;
                width: 90%;
                margin: 20px auto 0;
            }
        }

        @media (max-width: 600px) {
            #weather.bookmark {
                display: none;
                position: static;
                margin: 20px auto;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar removed -->
    <aside class="tools">
        <div id="weather" class="bookmark">Loading weather...</div>
    </aside>
    <!-- Footer bar removed -->
    <!-- Settings gear and modal removed -->
    <h1 id="greeting">Loading greeting...</h1>
    <div class="quote" id="quote">"Loading quote..."</div>
    <div class="clock" id="clock">Loading time...</div>


    <div class="search-bar">
        <form id="searchForm" action="https://www.google.com/search" method="get" target="_self">
            <input type="text" name="q" id="searchInput" placeholder="Searchâ€¦" />
        </form>
        <div class="engine-wrapper">
            <img id="currentEngineIcon" src="https://www.google.com/favicon.ico" class="engine-icon active">
            <div class="engine-select" id="engineSelect">
                <img src="https://www.google.com/favicon.ico" data-action="google" class="engine-icon">
                <img src="https://duckduckgo.com/favicon.ico" data-action="duckduckgo" class="engine-icon">
                <img src="https://brave.com/static-assets/images/brave-favicon.png" data-action="brave"
                    class="engine-icon">
            </div>
        </div>
    </div>

    <div class="bookmarks" id="bookmarks"></div>

    <script>
        function updateGreeting() {
            // Load saved name or default to Tokyo
            const userName = localStorage.getItem('username') || 'Tokyo';
            const hour = new Date().getHours();
            let greeting = "Hello";
            let emoji = "ðŸŒž";

            if (hour >= 5 && hour < 12) {
                greeting = "Good Morning";
                emoji = "ðŸŒ…";
            } else if (hour >= 12 && hour < 18) {
                greeting = "Good Afternoon";
                emoji = "ðŸŒž";
            } else if (hour >= 18 && hour < 22) {
                greeting = "Good Evening";
                emoji = "ðŸŒ‡";
            } else {
                greeting = "Good Night";
                emoji = "ðŸŒ™";
            }

            const g = document.getElementById("greeting");
            g.innerHTML = `${greeting}, <span id="username">${userName}</span> ${emoji}`;

            // Make username clickable to change it
            const nameSpan = document.getElementById("username");
            nameSpan.addEventListener("click", () => {
                const newName = prompt("Enter your name:", userName);
                if (newName) {
                    localStorage.setItem("username", newName);
                    updateGreeting();
                }
            });
        }
        updateGreeting();

        /* ---------- Local Wallpaper Picker (folder "wallpaper") ---------- */
        const localWallpapers = Array.from({ length: 8 }, (_, i) => `wallpaper/bg${i + 1}.webp`);

        function pickLocalWallpaper() {
            let idx = Number(localStorage.getItem('wallpaperIndex') || 0);
            document.body.style.backgroundImage = `url('${localWallpapers[idx]}')`;
            localStorage.setItem('wallpaperIndex', (idx + 1) % localWallpapers.length);
        }
        pickLocalWallpaper();

        // Clock
        function updateClock() {
            const now = new Date();
            const hours = now.getHours() % 12 || 12;
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
            document.getElementById('clock').textContent = `${hours}:${minutes} ${ampm}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Quote of the Day
        const quotes = [
            "Keep going. Everything you need will come to you.",
            "Discipline is choosing between what you want now and what you want most.",
            "The grind never lies.",
            "Focus beats talent when talent doesnâ€™t focus.",
            "Success is the sum of small efforts repeated day in and day out.",
            "Push yourself, because no one else is going to do it for you.",
            "The only limit to your impact is your imagination and commitment.",
            "You don't have to be great to start, but you have to start to be great.",
            "Hard work beats talent when talent doesn't work hard.",
            "Dream big. Start small. Act now.",
            "Every champion was once a contender who refused to give up.",
            "Don't watch the clock; do what it does. Keep going.",
            "You are your only limit.",
            "Wake up with determination. Go to bed with satisfaction.",
            "Small steps every day lead to big results.",
            "Be stronger than your excuses.",
            "Start where you are. Use what you have. Do what you can.",
            "If it doesn't challenge you, it won't change you.",
            "You miss 100% of the shots you don't take.",
            "Be so good they can't ignore you.",
            "Work until your idols become your rivals.",
            "Donâ€™t limit your challenges. Challenge your limits.",
            "Nothing worth having comes easy.",
            "Stay hungry. Stay foolish.",
            "Winners focus on winning. Losers focus on winners.",
            "Grind in silence. Let success make the noise.",
            "Consistency is more important than perfection.",
            "Stop doubting yourself. Work hard and make it happen.",
            "The pain you feel today will be the strength you feel tomorrow.",
            "Action is the foundational key to all success."
        ];
        document.getElementById('quote').textContent = quotes[Math.floor(Math.random() * quotes.length)];

        // ðŸ” Search Engine Switcher
        const engines = {
            google: { action: 'https://www.google.com/search', icon: 'https://www.google.com/favicon.ico' },
            duckduckgo: { action: 'https://duckduckgo.com/', icon: 'https://duckduckgo.com/favicon.ico' },
            brave: { action: 'https://search.brave.com/search', icon: 'https://brave.com/static-assets/images/brave-favicon.png' }
        };

        const currentIcon = document.getElementById('currentEngineIcon');
        const engineSelect = document.getElementById('engineSelect');
        const form = document.getElementById('searchForm');

        currentIcon.addEventListener('click', () => {
            engineSelect.classList.toggle('show');
        });

        engineSelect.querySelectorAll('.engine-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const eng = engines[icon.dataset.action];
                form.action = eng.action;
                currentIcon.src = eng.icon;
                engineSelect.classList.remove('show');

                const searchInput = document.getElementById('searchInput');
                if (icon.dataset.action === 'duckduckgo') {
                    searchInput.placeholder = "Search Anonymously";
                } else {
                    searchInput.placeholder = `Search with ${icon.dataset.action.charAt(0).toUpperCase() + icon.dataset.action.slice(1)}`;
                }
            });
        });

        document.getElementById('searchInput').placeholder = "Search with Google";

        function addBookmarkPrompt() {
            // Ask for a short URL, prepend protocol if missing
            const input = prompt("Enter site URL (e.g. facebook.com)", "");
            if (!input) return;
            const url = input.startsWith("http://") || input.startsWith("https://")
                ? input
                : `https://${input}`;

            // Prompt for a display name or derive from hostname
            const name = prompt("Enter site name (optional):", "") ||
                new URL(url).hostname.replace("www.", "");

            // Save bookmark and re-render
            bookmarks.push({
                url,
                name,
                icon: `${new URL(url).origin}/favicon.ico`
            });
            localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        // Bookmarks (editable)
        // Load or seed bookmarks
        let bookmarks = JSON.parse(localStorage.getItem('customBookmarks') || "[]");
        if (bookmarks.length === 0) {
            bookmarks = [
                { name: "YouTube Music", url: "https://music.youtube.com/", icon: "https://music.youtube.com/favicon.ico" },
                { name: "Reddit", url: "https://www.reddit.com", icon: "https://www.redditstatic.com/desktop2x/img/favicon/favicon-32x32.png" },
                { name: "GitHub", url: "https://github.com", icon: "https://github.githubassets.com/favicons/favicon.png" },
                { name: "Twitter", url: "https://twitter.com", icon: "https://abs.twimg.com/favicons/twitter.ico" }
            ];
            localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
        }

        async function fetchTitle(url) {
            try {
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const title = doc.querySelector('title');
                return title ? title.innerText.trim() : null;
            } catch {
                return null;
            }
        }

        async function renderBookmarks() {
            // Load current bookmarks list
            bookmarks = JSON.parse(localStorage.getItem('customBookmarks'));
            const container = document.getElementById('bookmarks');
            container.innerHTML = "";

            for (let i = 0; i < bookmarks.length; i++) {
                const b = bookmarks[i];
                const url = new URL(b.url);
                let name = b.name;
                if (!name) {
                    name = await fetchTitle(b.url);
                    name = name || url.hostname.replace("www.", "");
                    bookmarks[i].name = name;
                    localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
                }
                const icon = b.icon || `${url.origin}/favicon.ico`;

                const a = document.createElement('a');
                a.href = b.url;
                a.target = "_self";
                a.className = "bookmark";
                a.innerHTML = `<img src="${icon}" alt="${name}" class="bookmark-icon"><span class="bookmark-name">${name}</span>`;

                a.addEventListener('click', (e) => {
                    // Left click opens the link
                    window.location.href = b.url;
                });

                a.addEventListener('contextmenu', async (e) => {
                    e.preventDefault();
                    const newUrl = prompt(`Edit URL for ${name}:`, b.url);
                    const newName = prompt(`Edit Name for ${name}:`, name);
                    if (newUrl && newName !== null) {
                        const updatedUrl = new URL(newUrl.startsWith("http") ? newUrl : "https://" + newUrl);
                        bookmarks[i] = {
                            url: updatedUrl.href,
                            name: newName,
                            icon: `${updatedUrl.origin}/favicon.ico`
                        };
                        localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
                        renderBookmarks();
                    }
                });

                // --- Drag and Drop for custom bookmarks ---
                a.setAttribute('draggable', 'true');
                a.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', i.toString());
                });
                a.addEventListener('dragover', e => {
                    e.preventDefault();
                });
                a.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
                    const toIndex = i;
                    // Only reorder bookmarks if both are user-editable (all bookmarks are now editable)
                    const [moved] = bookmarks.splice(fromIndex, 1);
                    bookmarks.splice(toIndex, 0, moved);
                    localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
                    renderBookmarks();
                });
                // ---

                container.appendChild(a);
            }
            // --- "add bookmark" tile ---
            const addTile = document.createElement('div');
            addTile.className = 'bookmark-add';
            addTile.textContent = '+';
            addTile.title = "Add bookmark";
            addTile.setAttribute('draggable', 'false');
            addTile.addEventListener('click', () => addBookmarkPrompt());
            container.appendChild(addTile);
        }
        renderBookmarks();
        // Settings modal, quote toggle, and to-do listeners removed

        // Helper to map weather codes to emoji
        function getWeatherEmoji(code) {
            if (code === 0) return 'â˜€ï¸';
            if (code >= 1 && code <= 3) return 'ðŸŒ¤ï¸';
            if (code >= 45 && code <= 48) return 'ðŸŒ«ï¸';
            if ((code >= 51 && code <= 67) || (code >= 80 && code <= 86)) return 'ðŸŒ§ï¸';
            if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) return 'ðŸŒ¨ï¸';
            if (code >= 95 && code <= 99) return 'â›ˆï¸';
            return 'â˜ï¸';
        }

        // Fetch weather given coords and location labels
        async function fetchWeather(latitude, longitude, city, country) {
            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`;
            try {
                const data = await fetch(weatherUrl).then(r => r.json());
                const cw = data.current_weather;
                const daily = data.daily;
                const w = document.getElementById('weather');
                const up = new Date(cw.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                let html = `
              <div class="weather-header">
                <div class="weather-location">${city}${country ? ', ' + country : ''}</div>
                <div class="weather-update">update: ${up}</div>
              </div>
              <div class="weather-main">
                <div class="weather-icon">${getWeatherEmoji(cw.weathercode)}</div>
                <div class="weather-temp-large">${cw.temperature.toFixed(1)}Â°C</div>
              </div>
              <div class="weather-forecast">`;
                const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                for (let i = 1; i <= 4; i++) {
                    const d = new Date(daily.time[i]);
                    const day = weekdays[d.getDay()];
                    const icon = getWeatherEmoji(daily.weathercode[i]);
                    const min = daily.temperature_2m_min[i].toFixed(1);
                    const max = daily.temperature_2m_max[i].toFixed(1);
                    html += `
                <div class="forecast-day">
                  <div class="forecast-name">${day}</div>
                  <div class="forecast-icon">${icon}</div>
                  <div class="forecast-range">${min}-${max}Â°</div>
                </div>`;
                }
                html += `</div>`;
                w.innerHTML = html;
            } catch {
                // silent
            }
        }

        // Fallback to IP-based lookup
        function fetchWeatherByIP() {
            fetch('https://ipapi.co/json/')
                .then(r => r.json())
                .then(loc => {
                    fetchWeather(loc.latitude, loc.longitude, loc.city, loc.country_name);
                })
                .catch(() => {/* silent */ });
        }

        // Try geolocation first, then fallback
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    const { latitude, longitude } = pos.coords;
                    // Reverse geocode for city/country
                    let city = 'Your Location', country = '';
                    try {
                        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&language=en`);
                        const geoData = await geoRes.json();
                        if (geoData.results && geoData.results.length) {
                            city = geoData.results[0].name;
                            country = geoData.results[0].country;
                        }
                    } catch { }
                    fetchWeather(latitude, longitude, city, country);
                },
                () => { fetchWeatherByIP(); }
            );
        } else {
            fetchWeatherByIP();
        }
        // Hide weather widget if it overlaps the clock or greeting
        function checkWeatherOverlap() {
            const weather = document.getElementById('weather');
            const clock = document.getElementById('clock');
            const greeting = document.getElementById('greeting');
            if (!weather || !clock || !greeting) return;
            // Hide on narrow viewports
            if (window.innerWidth < 1000) {
                weather.style.display = 'none';
                return;
            }
            const wRect = weather.getBoundingClientRect();
            const cRect = clock.getBoundingClientRect();
            const gRect = greeting.getBoundingClientRect();
            const overlapClock = !(wRect.right < cRect.left ||
                wRect.left > cRect.right ||
                wRect.bottom < cRect.top ||
                wRect.top > cRect.bottom);
            const overlapGreeting = !(wRect.right < gRect.left ||
                wRect.left > gRect.right ||
                wRect.bottom < gRect.top ||
                wRect.top > gRect.bottom);
            const overlap = overlapClock || overlapGreeting;
            weather.style.display = overlap ? 'none' : '';
        }
        window.addEventListener('load', checkWeatherOverlap);
        window.addEventListener('resize', checkWeatherOverlap);
    </script>
</body>

</html>
